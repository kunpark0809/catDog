<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="admin">

	<!-- 대소문자 구분 없이 검색되도록 하는 조건문(데이터 양 엄청 많아지면 부하 좀 걸릴 수도 있음) -->
	<sql id="member-where-list">
		<if test="condition=='all' ">
			(INSTR(LOWER(userId), LOWER(#{keyword})) &gt; 0
			OR INSTR(LOWER(nickName), LOWER(#{keyword})) &gt; 0
			OR INSTR(reportCount, #{keyword}) &gt; 0)
		</if>
		<if test="condition=='userId' ">
			INSTR(LOWER(userId), LOWER(#{keyword})) &gt; 0
		</if>
		<if test="condition=='nickName' ">
			INSTR(LOWER(nickName), LOWER(#{keyword})) &gt; 0
		</if>
		<if test="condition=='reportCount' ">
			INSTR(reportCount, #{keyword}) &gt; 0
		</if>
	</sql>

	<sql id="report-where-list">
		<if test="condition=='all' ">
			(INSTR(LOWER(userId), LOWER(#{keyword})) &gt; 0
			OR INSTR(LOWER(nickName), LOWER(#{keyword})) &gt; 0
			OR INSTR(reasonName, #{keyword}) &gt; 0)
		</if>
		<if test="condition=='userId' ">
			INSTR(LOWER(userId), LOWER(#{keyword})) &gt; 0
		</if>
		<if test="condition=='nickName' ">
			INSTR(LOWER(nickName), LOWER(#{keyword})) &gt; 0
		</if>
		<if test="condition=='reasonName' ">
			INSTR(reasonName, #{keyword}) &gt; 0
		</if>
	</sql>

	<sql id="report-group-list">
			<choose>
				<when test="group==1">
					boardSort==1
				</when>		
				<when test="group==2">
					boardSort==2
				</when>		
				<when test="group==3">
					boardSort==3
				</when>		
			</choose>
	</sql>



<!-- 주문정보 리스트에서 검색 기능을 넣을거면 사용할 sql -->
	<sql id="order-where-list">
		<choose>
			<when test="condition == 'created' ">
			   ( TO_CHAR(created, 'YYYYMMDD') = #{keyword}
		          OR TO_CHAR(created, 'YYYY-MM-DD') = #{keyword} )
			</when>
		</choose>
	</sql>



<!--모든 품목의 월별 매출(금액). 년도와 월을 YYYYMM 꼴로 결합해야 함. 연도별 -->
<select id="monthSalesByCategory" parameterType="Map" resultType="com.catDog.admin.Money">
SELECT p.smallSortNum, ss.sortName smallSortName, TO_CHAR(requestDate,'YYYYMM') requestDate, SUM(NVL(productSum,0)) productSum FROM request r
JOIN requestDetail rd ON r.requestNum = rd.requestNum 
JOIN product p ON rd.productNum = p.productNum
JOIN smallSort ss ON p.smallSortNum = ss.smallSortNum
WHERE p.smallSortNum = #{smallSortNum}
<![CDATA[
		AND TO_CHAR(requestDate, 'YYYY') >= #{year} AND
		TO_CHAR(requestDate, 'YYYY') < #{year}+1
	]]>
GROUP BY p.smallSortNum, ss.sortName, TO_CHAR(requestDate,'YYYYMM')
ORDER BY requestDate ASC
</select>

<!-- 해당 smallSortNum의 sortName을 가져오는 쿼리. 연도별 -->
<select id="getCategory" parameterType="Integer" resultType="String">
	SELECT sortName FROM smallSort WHERE smallSortNum = #{smallSortNum}	
</select>


<!--모든 품목의 분기별 매출(금액). 년도와 월을 YYYYMM 꼴로 결합해야 함. 가져온 후에 결과값을 Controller에서 1~3/4~6/7~9/10~12끼리 합쳐야 함. 분기 -->
<select id="quarterSalesByCategory" parameterType="Map" resultType="com.catDog.admin.Money">
SELECT p.smallSortNum, ss.sortName smallSortName, TO_CHAR(requestDate,'YYYYMM') requestDate, SUM(NVL(productSum,0)) productSum FROM request r
JOIN requestDetail rd ON r.requestNum = rd.requestNum 
JOIN product p ON rd.productNum = p.productNum
JOIN smallSort ss ON p.smallSortNum = ss.smallSortNum
WHERE p.smallSortNum = #{smallSortNum}
<![CDATA[
		AND TO_CHAR(requestDate, 'YYYY') >= #{year} AND
		TO_CHAR(requestDate, 'YYYY') <= #{year}+3
	]]>
GROUP BY p.smallSortNum, ss.sortName, TO_CHAR(requestDate,'YYYYMM')
ORDER BY requestDate ASC
</select>

<!-- 연도별 매출. 이번 년도의 매출 출력에도 사용. 소계에 사용 -->
<select id="yearSales" parameterType="String" resultType="Integer">
	SELECT NVL(SUM(purchase),0) yearSales 
	FROM request r
	JOIN payment p ON r.requestNum =  p.requestNum
	<![CDATA[
		WHERE TO_CHAR(requestDate, 'YYYY') >= #{year} AND
		TO_CHAR(requestDate, 'YYYY') < #{year}+1
	]]>
</select>

<!-- 전체 기간동안의 매출. 소계에 사용 -->
<select id="totalSales" resultType="Integer">
	SELECT NVL(SUM(purchase),0) sales 
	FROM request r
	JOIN payment p ON r.requestNum =  p.requestNum
</select>


<!-- year와 smallSortNum 입력해서 해당 카테고리의 해당 년도의 총매출을 출력. 품목별 -->
<select id="categorySales" parameterType="Map" resultType="com.catDog.admin.Money">
	SELECT bs.bigSortNum, bs.sortName bigSortName, p.smallSortNum, ss.sortName smallSortName, SUM(productSum) sales FROM requestDetail rd
		JOIN product p ON rd.productNum = p.productNum
		JOIN smallSort ss ON p.smallSortNum = ss.smallSortNum
		JOIN bigSort bs ON ss.bigSortNum = bs.bigSortNum
		JOIN request r ON rd.requestNum = r.requestNum
	WHERE p.smallSortNum = #{smallSortNum}
		AND TO_CHAR(requestDate, 'YYYY') = #{year}
	GROUP BY bs.bigSortNum, bs.sortName, p.smallSortNum, ss.sortName
</select>

<!-- year와 smallSortNum 입력해서 해당 카테고리의 해당 년도의 총 판매개수를 출력. 품목별 -->
<select id="categorySalesVolume" parameterType="Map" resultType="com.catDog.admin.Money">
	SELECT bs.bigSortNum, bs.sortName bigSortName, p.smallSortNum, ss.sortName smallSortName, SUM(productCount) salesVolume FROM requestDetail rd
		JOIN product p ON rd.productNum = p.productNum
		JOIN smallSort ss ON p.smallSortNum = ss.smallSortNum
		JOIN bigSort bs ON ss.bigSortNum = bs.bigSortNum
		JOIN request r ON rd.requestNum = r.requestNum
	WHERE p.smallSortNum = #{smallSortNum}
		AND TO_CHAR(requestDate, 'YYYY') = #{year}
	GROUP BY bs.bigSortNum, bs.sortName, p.smallSortNum, ss.sortName
</select>

<!-- 회원 리스트 -->
<!-- 회원의 정보를 memberDetail에서 가져오면서 request에서 번호로 GROUP BY하여 COUNT한 테이블(주문횟수)과도 JOIN -->
<select id="memberList" parameterType="Map" resultType="com.catDog.admin.Member">
	SELECT md.num, md.userId, name, nickName, mileage, NVL(count, 0) requestCount,
		reportCount, failure_cnt, lastLogin, NVL(stateCode, 0) stateCode
	FROM memberDetail md
	LEFT OUTER JOIN (
		SELECT num, NVL(COUNT(*), 0) count FROM request GROUP BY num
	) rc ON md.num = rc.num
	LEFT OUTER JOIN customerDetail cd ON md.num = cd.num
	LEFT OUTER JOIN (
		SELECT * FROM
    		(SELECT RANK() OVER (PARTITION BY userId ORDER BY memberStateNum DESC) rn,
    		memberStateNum, userId, stateCode
			FROM memberState)
        WHERE rn = 1) ms
	ON md.userId = ms.userId
	<where>
		INSTR(md.userId, 'admin') = 0
		<if test="keyword != null and keyword != ''">
			 AND <include refid="member-where-list"/>
		</if>
	</where>
	ORDER BY md.num DESC
	OFFSET #{offset} ROWS FETCH FIRST #{rows} ROWS ONLY
</select>

<!-- 전체 주문내역 리스트(회원 + 비회원) -->
<!-- 주문번호, 포인트사용 및 실 결제액, 주문날짜, 진행상태, 회원이라면 아이디 아니면 '비회원' 가져오기 -->
<select id="orderList" parameterType="Map" resultType="com.catDog.admin.Member">
	SELECT requestNum, point, purchase, TO_CHAR(requestDate, 'YYYY-MM-DD HH24:MI:SS') requestDate,
	status, NVL(userId, '비회원') FROM request r
	JOIN payment p ON r.requestNum = p.requestNum
	LEFT OUTER JOIN memberDetail md ON md.num = r.num
	ORDER BY num DESC
	OFFSET #{offset} ROWS FETCH FIRST #{rows} ROWS ONLY
</select>

<!-- 회원 수 세기 -->
<select id="memberCount" parameterType="Map" resultType="Integer">
		SELECT NVL(COUNT(*), 0)
		FROM memberDetail md
	<where>
		INSTR(userId, 'admin') = 0
		<if test="keyword!=null and keyword!='' ">
			 AND <include refid="member-where-list"/>
		</if>
	</where>   
</select>

<!-- 신고된 글들 가져오기. 조인해서 reasonName, reporterId, reporterNickName, 
	reportedId, reportedNickName 가져옴  -->
<select id="reportList" parameterType="Map" resultType="com.catDog.admin.Report">
	SELECT reportNum, boardSort, reportedPostNum, reportDate,  
		r.reasonSortNum, reasonName,	 
		reporterNum, md1.userId reporterId, md1.nickName reporterNickName, 
		reportedNum, md2.userId reportedId, md2.nickName reportedNickName 
	FROM report r 
	JOIN reasonSort rs  
		ON r.reasonSortNum = rs.reasonSortNum 
	JOIN memberDetail md1 ON r.reporterNum = md1.num 
	JOIN memberDetail md2 ON r.reportedNum = md2.num 
	<where>
		<if test="keyword!=null and keyword!=''">
			<include refid="report-where-list"/>
			AND 
		</if>
		<include refid="report-group-list"/> 
	</where>
	ORDER BY reportNum DESC 
	OFFSET #{offset} ROWS FETCH FIRST #{rows} ROWS ONLY
</select>

<select id="reportCount" parameterType="Map" resultType="Integer">
	SELECT NVL(COUNT(*), 0) FROM report
	<where>
		<if test="keyword!=null and keyword!=''">
			<include refid="report-where-list"/>		
			AND
		</if>
		<include refid="report-group-list"/>
	</where>
</select>




</mapper>